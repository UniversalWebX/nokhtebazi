<!DOCTYPE html>
<html>
<head>
    <title>Nokhtebazi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/x-icon" href="icon.ico">
    <style>
        :root { --accent: #00f2ff; --bg: #0a0a0a; }
        body { font-family: 'Orbitron', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; touch-action: none; }
        body.rtl { direction: rtl; }
        
        #auth-screen, #end-screen { 
            position: fixed; inset: 0; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        #ui-layer { 
            position: fixed; top: 10px; left: 10px; background: rgba(30, 30, 35, 0.95); 
            padding: 15px; border-radius: 12px; z-index: 500; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: move; width: 200px; max-width: 80vw;
        }
        #board-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; }
        #board { 
            position: absolute; display: grid; transform-origin: 0 0;
            grid-template-columns: repeat(25, 8px 50px) 8px;
            grid-template-rows: repeat(25, 8px 50px) 8px;
            padding: 300px;
        }

        .dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .line { background: #1a1a1a; cursor: pointer; position: relative; }
        .line::after { content: ''; position: absolute; inset: -8px; z-index: 1; } 
        .line:hover:not(.taken) { background: #333; }
        .line.h { width: 50px; height: 8px; border-radius: 4px; }
        .line.v { width: 8px; height: 50px; border-radius: 4px; }
        .line.taken { box-shadow: 0 0 10px currentColor; z-index: 2; }
        .box { width: 50px; height: 50px; transition: background 0.4s; border-radius: 4px; }

        .remote-cursor { position: absolute; width: 12px; height: 12px; border-radius: 50%; pointer-events: none; z-index: 1000; }
        .cursor-label { position: absolute; top: -22px; left: 10px; font-size: 10px; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; white-space: nowrap; }

        /* Joystick Styles */
        #joystick-wrapper { 
            position: fixed; bottom: 40px; left: 40px; width: 100px; height: 100px; 
            background: rgba(255,255,255,0.1); border-radius: 50%; display: none; 
            touch-action: none; z-index: 1000; border: 1px solid var(--accent);
        }
        #joystick-stick { 
            position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; 
            background: var(--accent); border-radius: 50%; opacity: 0.6;
        }

        button { background: var(--accent); border: none; color: #000; padding: 12px; border-radius: 6px; cursor: pointer; font-family: 'Orbitron'; font-weight: bold; width: 100%; margin-top: 8px; font-size: 14px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; width: calc(100% - 22px); font-family: 'Orbitron'; font-size: 16px; }
        
        .status-box { border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 15px; }
        body.rtl .status-box { border-left: none; border-right: 4px solid var(--accent); padding-right: 10px; }
        #scoreboard { font-size: 12px; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; max-height: 100px; overflow-y: auto; }
        #copy-toast { font-size: 9px; color: var(--accent); opacity: 0; transition: 0.3s; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="auth-screen">
        <h1 id="main-title" style="color: var(--accent);">Nokhtebazi</h1>
        <input type="text" id="username" placeholder="Enter Name">
        <button id="play-btn" onclick="login()">Play Game</button>
    </div>

    <div id="end-screen" style="display:none">
        <h1 id="game-over-text">Game Over</h1>
        <div id="final-stats"></div>
        <button id="restart-btn" onclick="location.reload()">Play Again</button>
    </div>

    <div id="game-screen" style="display:none">
        <div id="ui-layer">
            <div class="status-box">
                <small id="turn-label">Turn</small>
                <div id="turn-display">---</div>
            </div>
            <div id="room-controls">
                <button id="create-btn" onclick="createRoom()">Create Room</button>
                <input type="text" id="room-input" placeholder="Room Code" maxlength="6" style="margin-top: 10px;">
                <button id="join-btn" onclick="joinRoom()">Join Room</button>
            </div>
            <div id="active-info" style="display:none; text-align: center; cursor: pointer;" onclick="copyCode()">
                <span id="room-label">Room:</span> <b id="room-id" style="color: var(--accent);"></b>
                <div id="copy-toast">COPIED / کپی شد</div>
            </div>
            <div style="margin-top:15px;">
                <label id="zoom-label" style="font-size: 9px; opacity: 0.6;">ZOOM LEVEL</label>
                <input type="range" id="zoom-range" min="0.2" max="2.0" step="0.01" value="0.8" oninput="setZoom(this.value)" style="width:100%">
            </div>
            <button style="font-size: 10px; padding: 5px;" onclick="toggleLanguage()">FA / EN</button>
            <div id="scoreboard"></div>
        </div>
        <div id="board-container"><div id="board"></div></div>
    </div>

    <div id="joystick-wrapper"><div id="joystick-stick"></div></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, myRoom, isMyTurn = false, boxesLeft = 625;
        let px = -500, py = -500, zoom = 0.8;
        let scores = {}, currentLang = 'en';

        const translations = {
            en: { mainTitle: "Nokhtebazi", enterName: "Enter Name", playGame: "Play Game", gameOver: "Game Over", playAgain: "Play Again", turn: "Turn", yourTurn: "Your Turn", createRoom: "Create Room", joinRoom: "Join Room", roomCode: "Room Code", room: "Room:", zoom: "ZOOM LEVEL" },
            fa: { mainTitle: "نقطه بازی", enterName: "نام خود را وارد کنید", playGame: "شروع بازی", gameOver: "بازی تمام شد", playAgain: "دوباره", turn: "نوبت", yourTurn: "نوبت شماست", createRoom: "ساخت اتاق", joinRoom: "ورود به اتاق", roomCode: "کد اتاق", room: "اتاق:", zoom: "بزرگنمایی" }
        };

        // Environment Detection
        const isMobile = /Mobi|Android/i.test(navigator.userAgent) || ('ontouchstart' in window);
        if (isMobile) document.getElementById('joystick-wrapper').style.display = 'block';

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'fa' : 'en';
            const t = translations[currentLang];
            document.body.classList.toggle('rtl', currentLang === 'fa');
            document.getElementById('username').placeholder = t.enterName;
            document.getElementById('play-btn').innerText = t.playGame;
            document.getElementById('main-title').innerText = t.mainTitle;
            document.getElementById('turn-label').innerText = t.turn;
            document.getElementById('create-btn').innerText = t.createRoom;
            document.getElementById('join-btn').innerText = t.joinRoom;
            document.getElementById('room-input').placeholder = t.roomCode;
            document.getElementById('room-label').innerText = t.room;
            document.getElementById('zoom-label').innerText = t.zoom;
            document.getElementById('game-over-text').innerText = t.gameOver;
            document.getElementById('restart-btn').innerText = t.playAgain;
        }

        function copyCode() {
            const code = document.getElementById('room-id').innerText;
            navigator.clipboard.writeText(code).then(() => {
                const t = document.getElementById('copy-toast');
                t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000);
            });
        }

        function login() {
            const val = document.getElementById('username').value;
            if (val.trim()) { myName = val; socket.emit('login', myName); }
        }

        socket.on('loginAuthorized', () => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            initGrid(); updateView();
        });

        function initGrid() {
            const board = document.getElementById('board');
            const frag = document.createDocumentFragment();
            for (let r = 0; r <= 50; r++) {
                for (let c = 0; c <= 50; c++) {
                    const d = document.createElement('div');
                    if (r % 2 === 0 && c % 2 === 0) d.className = 'dot';
                    else if (r % 2 === 0 && c % 2 !== 0) { d.className='line h'; d.id=`l-${r}-${c}`; d.onclick=()=>makeMove(r,c); }
                    else if (r % 2 !== 0 && c % 2 === 0) { d.className='line v'; d.id=`l-${r}-${c}`; d.onclick=()=>makeMove(r,c); }
                    else { d.className='box'; d.id=`b-${r}-${c}`; }
                    frag.appendChild(d);
                }
            }
            board.appendChild(frag);
        }

        function makeMove(r, c) {
            if (!isMyTurn || !myRoom) return;
            const el = document.getElementById(`l-${r}-${c}`);
            if (!el.classList.contains('taken')) socket.emit('makeMove', { r, c });
        }

        socket.on('updateTurn', (data) => {
            isMyTurn = (data.currentPlayer === myName);
            document.getElementById('turn-display').innerText = isMyTurn ? translations[currentLang].yourTurn : data.currentPlayer;
            let html = "";
            data.players.forEach(p => html += `<div style="color:${p.color}">${p.name}: ${scores[p.name] || 0}</div>`);
            document.getElementById('scoreboard').innerHTML = html;
        });

        socket.on('moveMade', (d) => {
            const l = document.getElementById(`l-${d.r}-${d.c}`);
            if(!l) return;
            l.style.background = d.color; l.classList.add('taken');
            const hit = checkBoxes(d.r, d.c, d.color, d.userName);
            if (d.userName === myName) socket.emit(hit > 0 ? 'boxClosed' : 'nextTurn');
        });

        function checkBoxes(r, c, color, user) {
            let count = 0;
            const pts = (r % 2 === 0) ? [[r-1, c], [r+1, c]] : [[r, c-1], [r, c+1]];
            pts.forEach(([br, bc]) => {
                const box = document.getElementById(`b-${br}-${bc}`);
                if (!box || box.style.background) return;
                const sides = [`l-${br-1}-${bc}`, `l-${br+1}-${bc}`, `l-${br}-${bc-1}`, `l-${br}-${bc+1}`];
                if (sides.every(id => document.getElementById(id)?.classList.contains('taken'))) {
                    box.style.background = color; box.style.opacity = "0.4";
                    scores[user] = (scores[user] || 0) + 1; boxesLeft--; count++;
                }
            });
            return count;
        }

        // --- Unified Controls (PC + Mobile) ---
        const ui = document.getElementById('ui-layer');
        let uiDrag = false, ux, uy, panDrag = false, lx, ly;

        const startAction = (e) => {
            const isTouch = e.type === 'touchstart';
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;

            if (e.target.closest('#ui-layer')) {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                    uiDrag = true; ux = clientX - ui.offsetLeft; uy = clientY - ui.offsetTop;
                }
            } else if (!e.target.closest('#joystick-wrapper')) {
                panDrag = true; lx = clientX; ly = clientY;
            }
        };

        const moveAction = (e) => {
            const isTouch = e.type === 'touchmove';
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;

            if (uiDrag) {
                ui.style.left = (clientX - ux) + 'px';
                ui.style.top = (clientY - uy) + 'px';
            }
            if (panDrag) {
                px += clientX - lx; py += clientY - ly;
                lx = clientX; ly = clientY; 
                updateView();
            }
            if (myRoom && !uiDrag && !panDrag) {
                const rect = document.getElementById('board').getBoundingClientRect();
                socket.emit('cursorMove', { x: (clientX - rect.left) / zoom, y: (clientY - rect.top) / zoom });
            }
        };

        const endAction = () => { uiDrag = false; panDrag = false; };

        window.addEventListener('mousedown', startAction);
        window.addEventListener('touchstart', startAction, { passive: false });
        window.addEventListener('mousemove', moveAction);
        window.addEventListener('touchmove', moveAction, { passive: false });
        window.addEventListener('mouseup', endAction);
        window.addEventListener('touchend', endAction);

        // --- Joystick Logic ---
        const joyWrapper = document.getElementById('joystick-wrapper');
        const joyStick = document.getElementById('joystick-stick');
        let joyActive = false, joyX = 0, joyY = 0;

        joyWrapper.addEventListener('touchstart', (e) => { joyActive = true; e.stopPropagation(); }, { passive: false });
        window.addEventListener('touchmove', (e) => {
            if (!joyActive) return;
            const touch = e.touches[0];
            const rect = joyWrapper.getBoundingClientRect();
            const centerX = rect.left + 50, centerY = rect.top + 50;
            let dx = touch.clientX - centerX, dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 50) { dx *= 50/dist; dy *= 50/dist; }
            joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx / 10; joyY = dy / 10;
        }, { passive: false });

        window.addEventListener('touchend', () => { 
            joyActive = false; joyStick.style.transform = `translate(0,0)`; joyX = 0; joyY = 0; 
        });

        function updateView() { document.getElementById('board').style.transform = `translate(${px}px, ${py}px) scale(${zoom})`; }
        function setZoom(v) { zoom = parseFloat(v); updateView(); }

        function gameLoop() {
            if (joyX !== 0 || joyY !== 0) { px -= joyX * 5; py -= joyY * 5; updateView(); }
            requestAnimationFrame(gameLoop);
        }
        gameLoop();

        function createRoom() { const c = Math.random().toString(36).substring(2, 8).toUpperCase(); document.getElementById('room-input').value = c; joinRoom(); }
        function joinRoom() { 
            myRoom = document.getElementById('room-input').value.toUpperCase(); 
            if(myRoom.length === 6) {
                socket.emit('joinRoom', myRoom); 
                document.getElementById('room-controls').style.display = 'none';
                document.getElementById('active-info').style.display = 'block';
                document.getElementById('room-id').innerText = myRoom;
            }
        }

        socket.on('cursorUpdate', (d) => {
            let c = document.getElementById(`c-${d.id}`);
            if (!c) {
                c = document.createElement('div'); c.id = `c-${d.id}`;
                c.className = 'remote-cursor';
                c.innerHTML = `<div class="cursor-label" style="color:${d.color}">${d.name}</div>`;
                document.getElementById('board').appendChild(c);
            }
            c.style.background = d.color; c.style.left = d.x + 'px'; c.style.top = d.y + 'px';
        });
        socket.on('cursorRemove', (id) => { const c = document.getElementById(`c-${id}`); if(c) c.remove(); });
        window.onwheel = (e) => { zoom = Math.min(Math.max(zoom + (e.deltaY < 0 ? 0.05 : -0.05), 0.1), 2.0); document.getElementById('zoom-range').value = zoom; updateView(); };
    </script>
</body>
</html>
