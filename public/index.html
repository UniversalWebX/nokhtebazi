<!DOCTYPE html>
<html>
<head>
    <title>Dots & Boxes 50x50 Multiplayer</title>
    <style>
        body { font-family: sans-serif; background: #111; color: #fff; margin: 0; overflow: hidden; }
        #auth-screen, #end-screen { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #game-screen { display: none; width: 100vw; height: 100vh; position: relative; }
        #ui-layer { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; z-index: 100; pointer-events: auto; border: 1px solid #444; }
        #board { position: absolute; display: grid; grid-template-columns: repeat(50, 10px 40px) 10px; grid-template-rows: repeat(50, 10px 40px) 10px; transform-origin: 0 0; }
        .dot { width: 10px; height: 10px; background: #555; border-radius: 50%; }
        .line { background: #222; cursor: pointer; }
        .line.h { width: 40px; height: 10px; }
        .line.v { width: 10px; height: 40px; }
        .line.taken { cursor: default; }
        .box { width: 40px; height: 40px; }
        .turn-highlight { border: 2px solid yellow; padding: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #owner-panel { display: none; margin-top: 10px; border-top: 1px solid red; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1>Dots & Boxes</h1>
        <input type="text" id="username" placeholder="Username">
        <button onclick="login()">Start Game</button>
    </div>

    <div id="end-screen" style="display:none">
        <h1>Game Over!</h1>
        <div id="final-stats"></div>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="game-screen">
        <div id="ui-layer">
            <div id="turn-display">Waiting for players...</div>
            <div id="party-controls">
                <button onclick="createParty()">Create Party</button>
                <input type="text" id="party-code" placeholder="6-Char Code" style="width:100px">
                <button onclick="join()">Join</button>
            </div>
            <div id="active-party" style="display:none">Room: <b id="room-text"></b></div>
            <div id="scoreboard"></div>
            
            <div id="owner-panel">
                <button onclick="socket.emit('ownerAction', {action:'lockdown'})">LOCKDOWN</button>
            </div>
        </div>
        <div id="board"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, myRoom, isMyTurn = false, totalCaptured = 0;
        let scores = {};
        const TOTAL_BOXES = 2500; // 50x50

        function login() {
            myName = document.getElementById('username').value;
            if(myName) socket.emit('login', myName);
        }

        socket.on('loginAuthorized', (data) => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            if(data.isOwner) document.getElementById('owner-panel').style.display = 'block';
            initBoard();
        });

        function initBoard() {
            const board = document.getElementById('board');
            for (let r = 0; r <= 100; r++) {
                for (let c = 0; c <= 100; c++) {
                    const div = document.createElement('div');
                    if (r % 2 === 0 && c % 2 === 0) div.className = 'dot';
                    else if (r % 2 === 0 && c % 2 !== 0) {
                        div.className = 'line h'; div.id = `line-${r}-${c}`;
                        div.onclick = () => tryMove(r, c);
                    } else if (r % 2 !== 0 && c % 2 === 0) {
                        div.className = 'line v'; div.id = `line-${r}-${c}`;
                        div.onclick = () => tryMove(r, c);
                    } else {
                        div.className = 'box'; div.id = `box-${r}-${c}`;
                    }
                    board.appendChild(div);
                }
            }
        }

        function tryMove(r, c) {
            if (!isMyTurn) return alert("Not your turn!");
            const el = document.getElementById(`line-${r}-${c}`);
            if (el.classList.contains('taken')) return;
            socket.emit('makeMove', { room: myRoom, r, c });
        }

        socket.on('updateTurn', (data) => {
            isMyTurn = (data.currentPlayer === myName);
            document.getElementById('turn-display').innerHTML = isMyTurn ? 
                "<b class='turn-highlight'>YOUR TURN!</b>" : `Turn: ${data.currentPlayer}`;
            
            // Update Scoreboard UI
            let html = "";
            data.players.forEach(p => {
                html += `<div style="color:${p.color}">${p.name}: ${scores[p.name] || 0}</div>`;
            });
            document.getElementById('scoreboard').innerHTML = html;
        });

        socket.on('moveMade', (data) => {
            const line = document.getElementById(`line-${data.r}-${data.c}`);
            line.style.background = data.color;
            line.classList.add('taken');

            const boxesClosed = checkBoxes(data.r, data.c, data.color, data.userName);
            
            if (data.userName === myName) {
                if (boxesClosed > 0) socket.emit('boxClosed');
                else socket.emit('nextTurn');
            }
        });

        function checkBoxes(r, c, color, user) {
            let found = 0;
            const potential = (r % 2 === 0) ? [[r-1, c], [r+1, c]] : [[r, c-1], [r, c+1]];
            
            potential.forEach(([br, bc]) => {
                const box = document.getElementById(`box-${br}-${bc}`);
                if (!box || box.style.background) return;
                const sides = [`line-${br-1}-${bc}`, `line-${br+1}-${bc}`, `line-${br}-${bc-1}`, `line-${br}-${bc+1}`];
                if (sides.every(s => document.getElementById(s).classList.contains('taken'))) {
                    box.style.background = color;
                    box.style.opacity = "0.6";
                    scores[user] = (scores[user] || 0) + 1;
                    totalCaptured++;
                    found++;
                }
            });

            if (totalCaptured === TOTAL_BOXES) endGame();
            return found;
        }

        function endGame() {
            document.getElementById('end-screen').style.display = 'flex';
            let stats = "";
            Object.entries(scores).forEach(([name, score]) => {
                stats += `<p>${name}: ${score} boxes</p>`;
            });
            document.getElementById('final-stats').innerHTML = stats;
        }

        // Navigation and Party Logic (Same as previous)
        function createParty() { const c = Math.random().toString(36).substring(2, 8).toUpperCase(); document.getElementById('party-code').value = c; join(); }
        function join() { 
            myRoom = document.getElementById('party-code').value.toUpperCase(); 
            socket.emit('joinRoom', myRoom); 
            document.getElementById('party-controls').style.display = 'none';
            document.getElementById('active-party').style.display = 'block';
            document.getElementById('room-text').innerText = myRoom;
        }

        let px=0, py=0;
        window.onkeydown=(e)=>{if(e.key=='ArrowUp')py+=40;if(e.key=='ArrowDown')py-=40;if(e.key=='ArrowLeft')px+=40;if(e.key=='ArrowRight')px-=40;document.getElementById('board').style.transform=`translate(${px}px,${py}px)`};
        socket.on('kick', (m)=>{alert(m);location.reload();});
    </script>
</body>
</html>
