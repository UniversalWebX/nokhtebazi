<!DOCTYPE html>
<html>
<head>
    <title>Nokhtebazi by UWX Studios</title>
    <style>
        :root { --glow: #00f2ff; --bg: #050505; --panel: #11111b; }
        body { font-family: 'Orbitron', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; }
        
        #auth-screen, #end-screen { 
            position: fixed; inset: 0; background: radial-gradient(circle, #111 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }

        #ui-layer { 
    position: fixed; 
    top: 20px; 
    left: 20px; 
    background: rgba(20, 20, 30, 0.85); 
    padding: 20px; 
    border-radius: 15px; 
    z-index: 500; /* High z-index to stay above the board */
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px); 
    box-shadow: 0 8px 32px 0 rgba(0,0,0,0.8);
    cursor: move; /* Indicates it can be dragged */
    user-select: none; /* Prevents text highlighting while dragging */
    width: 220px;
}

/* Optional: Add a small handle icon/bar at the top */
#ui-layer::before {
    content: "";
    display: block;
    width: 40px;
    height: 4px;
    background: rgba(255,255,255,0.2);
    margin: -10px auto 10px auto;
    border-radius: 2px;
}
        #board-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; }

        #board { 
            position: absolute; display: grid; transform-origin: 0 0;
            /* 25 boxes = 26 dots. 8px dot, 50px line */
            grid-template-columns: repeat(25, 8px 50px) 8px;
            grid-template-rows: repeat(25, 8px 50px) 8px;
            padding: 200px;
        }

        .dot { width: 8px; height: 8px; background: #444; border-radius: 50%; }
        .line { background: #1a1a1a; cursor: pointer; transition: all 0.2s ease; }
        .line:hover:not(.taken) { background: #333; box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .line.h { width: 50px; height: 8px; border-radius: 4px; }
        .line.v { width: 8px; height: 50px; border-radius: 4px; }
        
        .line.taken { box-shadow: 0 0 15px currentColor; z-index: 2; }
        .box { width: 50px; height: 50px; transition: background 0.5s ease; border-radius: 4px; }

        button { 
            background: linear-gradient(45deg, #007bff, #00f2ff); border: none; 
            color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        input { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .turn-card { border-left: 4px solid var(--glow); padding-left: 10px; margin-bottom: 15px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="auth-screen">
        <h1 style="letter-spacing: 5px; color: var(--glow);">Nokhtebazi</h1>
        <input type="text" id="username" placeholder="Enter Username">
        <button onclick="login()">Play</button>
    </div>

    <div id="end-screen" style="display:none">
        <h1 id="winner-text">MATCH COMPLETE</h1>
        <div id="final-stats"></div>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="game-screen" style="display:none">
        <div id="ui-layer">
            <div class="turn-card">
                <small>CURRENT TURN</small>
                <div id="turn-display" style="font-size: 1.2em; font-weight: bold;">---</div>
            </div>

            <div id="party-controls">
                <button onclick="createParty()">NEW PARTY</button>
                <input type="text" id="party-code" placeholder="CODE" style="width:80px; margin-top:10px;">
                <button onclick="join()">JOIN</button>
            </div>

            <div id="active-party" style="display:none; color: var(--glow); margin-top:10px;">ROOM: <b id="room-text"></b></div>
            
            <div style="margin-top:15px;">
                <label style="font-size: 10px;">ZOOM SCANNER</label><br>
                <input type="range" id="zoom-range" min="0.1" max="2.0" step="0.01" value="1.0" oninput="updateZoom(this.value)" style="width:100%">
            </div>

            <div id="scoreboard" style="font-size: 12px; margin-top:10px;"></div>
        </div>
        
        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, myRoom, isMyTurn = false, totalCaptured = 0;
        let px = 50, py = 50, zoom = 1.0;
        let scores = {};
        const GRID_SIZE = 25;

        function login() {
            myName = document.getElementById('username').value;
            if(myName) socket.emit('login', myName);
        }

        socket.on('loginAuthorized', (data) => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            initBoard();
            updatePos();
        });

        function initBoard() {
            const board = document.getElementById('board');
            const frag = document.createDocumentFragment();
            // 25 boxes means row/col indices up to 50 (2n)
            for (let r = 0; r <= GRID_SIZE * 2; r++) {
                for (let c = 0; c <= GRID_SIZE * 2; c++) {
                    const div = document.createElement('div');
                    if (r % 2 === 0 && c % 2 === 0) div.className = 'dot';
                    else if (r % 2 === 0 && c % 2 !== 0) {
                        div.className = 'line h'; div.id = `line-${r}-${c}`;
                        div.onclick = () => tryMove(r, c);
                    } else if (r % 2 !== 0 && c % 2 === 0) {
                        div.className = 'line v'; div.id = `line-${r}-${c}`;
                        div.onclick = () => tryMove(r, c);
                    } else {
                        div.className = 'box'; div.id = `box-${r}-${c}`;
                    }
                    frag.appendChild(div);
                }
            }
            board.appendChild(frag);
        }

        function tryMove(r, c) {
            if (!isMyTurn || !myRoom) return;
            const el = document.getElementById(`line-${r}-${c}`);
            if (el.classList.contains('taken')) return;
            socket.emit('makeMove', { r, c });
        }

        socket.on('updateTurn', (data) => {
            isMyTurn = (data.currentPlayer === myName);
            document.getElementById('turn-display').innerText = data.currentPlayer.toUpperCase();
            document.getElementById('turn-display').style.color = isMyTurn ? 'var(--glow)' : '#888';
            
            let scoreHtml = "";
            data.players.forEach(p => {
                scoreHtml += `<div style="color:${p.color}">${p.name}: ${scores[p.name] || 0}</div>`;
            });
            document.getElementById('scoreboard').innerHTML = scoreHtml;
        });

        socket.on('moveMade', (data) => {
            const line = document.getElementById(`line-${data.r}-${data.c}`);
            line.style.color = data.color;
            line.style.background = data.color;
            line.classList.add('taken');

            const closed = checkBoxes(data.r, data.c, data.color, data.userName);
            if (data.userName === myName) {
                if (closed > 0) socket.emit('boxClosed');
                else socket.emit('nextTurn');
            }
        });

        function checkBoxes(r, c, color, user) {
            let found = 0;
            const potential = (r % 2 === 0) ? [[r-1, c], [r+1, c]] : [[r, c-1], [r, c+1]];
            potential.forEach(([br, bc]) => {
                const box = document.getElementById(`box-${br}-${bc}`);
                if (!box || box.style.background) return;
                const sides = [`line-${br-1}-${bc}`, `line-${br+1}-${bc}`, `line-${br}-${bc-1}`, `line-${br}-${bc+1}`];
                if (sides.every(id => {
                    const s = document.getElementById(id);
                    return s && s.classList.contains('taken');
                })) {
                    box.style.background = color;
                    box.style.boxShadow = `inset 0 0 20px ${color}`;
                    box.style.opacity = "0.3";
                    scores[user] = (scores[user] || 0) + 1;
                    totalCaptured++;
                    found++;
                }
            });
            if (totalCaptured === GRID_SIZE * GRID_SIZE) endGame();
            return found;
        }

        function endGame() {
            document.getElementById('end-screen').style.display = 'flex';
            let stats = "";
            Object.entries(scores).sort((a,b)=>b[1]-a[1]).forEach(([name, score]) => {
                stats += `<p>${name}: ${score} boxes</p>`;
            });
            document.getElementById('final-stats').innerHTML = stats;
        }

        // Panning and Zooming logic
        function updateZoom(v) { zoom = parseFloat(v); updatePos(); }
        function updatePos() { document.getElementById('board').style.transform = `translate(${px}px, ${py}px) scale(${zoom})`; }

        window.addEventListener('wheel', (e) => {
            e.preventDefault();
            zoom = Math.min(Math.max(zoom + (e.deltaY < 0 ? 0.05 : -0.05), 0.1), 2.0);
            document.getElementById('zoom-range').value = zoom;
            updatePos();
        }, { passive: false });

        let dragging = false, lx, ly;
        window.onmousedown = (e) => { 
            if(e.target.closest('#ui-layer')) return;
            dragging=true; lx=e.clientX; ly=e.clientY; 
        };
        window.onmouseup = () => dragging = false;
        window.onmousemove = (e) => {
            if(!dragging) return;
            px += e.clientX - lx; py += e.clientY - ly;
            lx = e.clientX; ly = e.clientY; updatePos();
        };

        function createParty() { const c = Math.random().toString(36).substring(2, 8).toUpperCase(); document.getElementById('party-code').value = c; join(); }
        function join() { 
            myRoom = document.getElementById('party-code').value.toUpperCase(); 
            if(myRoom.length === 6) {
                socket.emit('joinRoom', myRoom); 
                document.getElementById('party-controls').style.display = 'none';
                document.getElementById('active-party').style.display = 'block';
                document.getElementById('room-text').innerText = myRoom;
            }
        }
        socket.on('kick', (m) => { alert(m); location.reload(); });
    </script>
</body>
</html>
