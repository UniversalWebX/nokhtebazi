
<!DOCTYPE html>
<html>
<head>
    <title>Nokhtebazi</title>
    <link rel="icon" type="image/x-icon" href="icon.ico">
    <style>
        :root { --accent: #00f2ff; --bg: #0a0a0a; }
        body { font-family: 'Orbitron', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; }
        
        #auth-screen, #end-screen { 
            position: fixed; inset: 0; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }

        #ui-layer { 
            position: fixed; top: 20px; left: 20px; background: rgba(30, 30, 35, 0.95); 
            padding: 20px; border-radius: 12px; z-index: 500; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: move; width: 220px;
        }

        #board-container { width: 100vw; height: 100vh; overflow: hidden; position: relative; }

        #board { 
            position: absolute; display: grid; transform-origin: 0 0;
            grid-template-columns: repeat(25, 8px 50px) 8px;
            grid-template-rows: repeat(25, 8px 50px) 8px;
            padding: 200px;
        }

        .dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .line { background: #1a1a1a; cursor: pointer; }
        .line:hover:not(.taken) { background: #333; }
        .line.h { width: 50px; height: 8px; border-radius: 4px; }
        .line.v { width: 8px; height: 50px; border-radius: 4px; }
        .line.taken { box-shadow: 0 0 10px currentColor; z-index: 2; }
        .box { width: 50px; height: 50px; transition: background 0.4s; border-radius: 4px; }

        .remote-cursor { position: absolute; width: 12px; height: 12px; border-radius: 50%; pointer-events: none; z-index: 1000; }
        .cursor-label { position: absolute; top: -22px; left: 10px; font-size: 10px; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; white-space: nowrap; }

        button { background: var(--accent); border: none; color: #000; padding: 12px; border-radius: 6px; cursor: pointer; font-family: 'Orbitron'; font-weight: bold; width: 100%; margin-top: 8px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; width: calc(100% - 22px); font-family: 'Orbitron'; }
        .status-box { border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 20px; }
        #scoreboard { font-size: 12px; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--accent);">Nokhtebazi</h1>
        <input type="text" id="username" placeholder="Enter Name">
        <button id="play-btn" onclick="login()">Play Game</button>
    </div>

    <div id="end-screen" style="display:none">
        <h1>Game Over</h1>
        <div id="final-stats"></div>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <div id="game-screen" style="display:none">
        <div id="ui-layer">
            <div class="status-box">
                <small>Turn</small>
                <div id="turn-display">---</div>
            </div>
            <div id="room-controls">
                <button onclick="createRoom()">Create Room</button>
                <input type="text" id="room-input" placeholder="Room Code" maxlength="6" style="margin-top: 10px;">
                <button onclick="joinRoom()">Join Room</button>
            </div>
            <div id="active-info" style="display:none; text-align: center;">
                Room: <b id="room-id" style="color: var(--accent);"></b>
            </div>
            <div style="margin-top:20px;">
                <label style="font-size: 9px; opacity: 0.6;">ZOOM LEVEL</label>
                <input type="range" id="zoom-range" min="0.1" max="2.0" step="0.01" value="1.0" oninput="setZoom(this.value)">
            </div>
            <div id="scoreboard"></div>
        </div>
        <div id="board-container">
            <div id="board"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myName, myRoom, isMyTurn = false, boxesLeft = 625;
        let px = 50, py = 50, zoom = 1.0;
        let scores = {};

        // Login Logic
        function login() {
            const nameInput = document.getElementById('username').value;
            if (nameInput.trim()) {
                myName = nameInput;
                socket.emit('login', myName);
            }
        }

        socket.on('loginAuthorized', (data) => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            initGrid();
            updateView();
        });

        // Grid & Game Logic
        function initGrid() {
            const board = document.getElementById('board');
            const frag = document.createDocumentFragment();
            for (let r = 0; r <= 50; r++) {
                for (let c = 0; c <= 50; c++) {
                    const d = document.createElement('div');
                    if (r % 2 === 0 && c % 2 === 0) d.className = 'dot';
                    else if (r % 2 === 0 && c % 2 !== 0) { 
                        d.className='line h'; d.id=`l-${r}-${c}`; 
                        d.onclick=()=>makeMove(r,c); 
                    }
                    else if (r % 2 !== 0 && c % 2 === 0) { 
                        d.className='line v'; d.id=`l-${r}-${c}`; 
                        d.onclick=()=>makeMove(r,c); 
                    }
                    else { d.className='box'; d.id=`b-${r}-${c}`; }
                    frag.appendChild(d);
                }
            }
            board.appendChild(frag);
        }

        function makeMove(r, c) {
            if (!isMyTurn || !myRoom) return;
            const el = document.getElementById(`l-${r}-${c}`);
            if (!el.classList.contains('taken')) socket.emit('makeMove', { r, c });
        }

        socket.on('updateTurn', (data) => {
            isMyTurn = (data.currentPlayer === myName);
            document.getElementById('turn-display').innerText = isMyTurn ? "Your Turn" : data.currentPlayer;
            let html = "";
            data.players.forEach(p => html += `<div style="color:${p.color}">${p.name}: ${scores[p.name] || 0}</div>`);
            document.getElementById('scoreboard').innerHTML = html;
        });

        socket.on('moveMade', (d) => {
            const l = document.getElementById(`l-${d.r}-${d.c}`);
            if(!l) return;
            l.style.background = d.color; l.classList.add('taken');
            const hit = checkBoxes(d.r, d.c, d.color, d.userName);
            if (d.userName === myName) socket.emit(hit > 0 ? 'boxClosed' : 'nextTurn');
        });

        function checkBoxes(r, c, color, user) {
            let count = 0;
            const pts = (r % 2 === 0) ? [[r-1, c], [r+1, c]] : [[r, c-1], [r, c+1]];
            pts.forEach(([br, bc]) => {
                const box = document.getElementById(`b-${br}-${bc}`);
                if (!box || box.style.background) return;
                const sides = [`l-${br-1}-${bc}`, `l-${br+1}-${bc}`, `l-${br}-${bc-1}`, `l-${br}-${bc+1}`];
                if (sides.every(id => {
                    const side = document.getElementById(id);
                    return side && side.classList.contains('taken');
                })) {
                    box.style.background = color; box.style.opacity = "0.4";
                    scores[user] = (scores[user] || 0) + 1; boxesLeft--; count++;
                }
            });
            if (boxesLeft === 0) showEnd();
            return count;
        }

        function showEnd() {
            document.getElementById('end-screen').style.display='flex';
            let res = ""; Object.entries(scores).forEach(([n, s]) => res += `<p>${n}: ${s}</p>`);
            document.getElementById('final-stats').innerHTML = res;
        }

        // HUD & View
        const ui = document.getElementById('ui-layer');
        let uiDrag = false, ux, uy;
        ui.onmousedown = (e) => { if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') { uiDrag = true; ux = e.clientX - ui.offsetLeft; uy = e.clientY - ui.offsetTop; } };
        
        window.onmousemove = (e) => {
            if (uiDrag) {
                ui.style.left = Math.max(0, Math.min(e.clientX - ux, window.innerWidth - ui.offsetWidth)) + 'px';
                ui.style.top = Math.max(0, Math.min(e.clientY - uy, window.innerHeight - ui.offsetHeight)) + 'px';
            }
            if (myRoom) {
                const rect = board.getBoundingClientRect();
                socket.emit('cursorMove', { x: (e.clientX - rect.left) / zoom, y: (e.clientY - rect.top) / zoom });
            }
            if (panDrag) {
                px += e.clientX - lx; py += e.clientY - ly;
                lx = e.clientX; ly = e.clientY; updateView();
            }
        };

        window.onmouseup = () => { uiDrag = false; panDrag = false; };

        socket.on('cursorUpdate', (d) => {
            let c = document.getElementById(`c-${d.id}`);
            if (!c) {
                c = document.createElement('div'); c.id = `c-${d.id}`;
                c.className = 'remote-cursor';
                c.innerHTML = `<div class="cursor-label" style="color:${d.color}">${d.name}</div>`;
                document.getElementById('board').appendChild(c);
            }
            c.style.background = d.color; c.style.left = d.x + 'px'; c.style.top = d.y + 'px';
        });

        socket.on('cursorRemove', (id) => { const c = document.getElementById(`c-${id}`); if(c) c.remove(); });

        function setZoom(v) { zoom = parseFloat(v); updateView(); }
        function updateView() { document.getElementById('board').style.transform = `translate(${px}px, ${py}px) scale(${zoom})`; }
        window.onwheel = (e) => { zoom = Math.min(Math.max(zoom + (e.deltaY < 0 ? 0.05 : -0.05), 0.1), 2.0); document.getElementById('zoom-range').value = zoom; updateView(); };

        let panDrag = false, lx, ly;
        window.onmousedown = (e) => { if(!e.target.closest('#ui-layer')) { panDrag=true; lx=e.clientX; ly=e.clientY; } };

        function createRoom() { const c = Math.random().toString(36).substring(2, 8).toUpperCase(); document.getElementById('room-input').value = c; joinRoom(); }
        function joinRoom() { 
            myRoom = document.getElementById('room-input').value.toUpperCase(); 
            if(myRoom.length === 6) {
                socket.emit('joinRoom', myRoom); 
                document.getElementById('room-controls').style.display = 'none';
                document.getElementById('active-info').style.display = 'block';
                document.getElementById('room-id').innerText = myRoom;
            }
        }
    </script>
</body>
</html>
